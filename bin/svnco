#!/usr/bin/env bash

FULL=

if [ "$1" == "--full" ]; then
	FULL=true
	shift
fi

if [ "$1" == "--with-qtp" ]; then
	QTP=true
	shift
fi

BRANCH="$1"

set -e

if [ -z "$BRANCH" ]; then
	echo "Usage: svnco [--full] [--with-qtp] <branch>[@<revision>]"
	exit 1
fi

SVNVERSION=`svn --version | sed -n '1s/.*version 1\.\([0-9]*\)\..*/\1/p'`

if [ -n "$QTP" ]; then
	svn -q co svn://svn.apama.com/branches/$BRANCH
else
	svn -q co -N svn://svn.apama.com/branches/$BRANCH
fi

REALBRANCH="` sed 's/@.*$//' <<< $BRANCH`"
REVISION="` sed 's/^.*@//' <<< $BRANCH`"
if [ "$REVISION" == "$REALBRANCH" ]; then
	REVISION=
else
	REVISION="-r $REVISION"
fi

cd `basename $REALBRANCH`

if [ -e apama-lib2 ]; then
	true
elif [ -e /var/tmp/apama-lib2 ]; then
		ln -sf /var/tmp/apama-lib2 .
else
		ln -sf /shared/apamabld/apama-lib2 .
fi

if [ -z "$QTP" ]; then
	if [ -n "$FULL" ]; then
		svn -q up $REVISION apama-src apama-test apama-build apama-doc apama-install apama-samples
	else
		if (( ${SVNVERSION} >= 7 )); then
			svn -q up $REVISION apama-src
			svn -q up -N $REVISION apama-test

		else
			svn -q up -N $REVISION apama-src apama-test
			FILES=$(cd apama-src; svn ls)
			(
				cd apama-src
				svn -q up $REVISION $FILES
				echo "apama-src checked out" 
			) &
		fi
		(
			cd apama-test 
			svn -q up $REVISION -N system etc doc examples unit
			svn -q up $REVISION licences python_scripts tools utils
			cd unit
			svn -q up $REVISION -N correlator-core  correlator-hypertree correlator-jmon cxxtest dsm junit lib samples studio
			svn -q up $REVISION cpp-common dotNet-common iaf java-common osee remote-executables sender-merger tools
			echo "apama-test partially checked out"
		) &
		wait
	fi
fi
svn switch --relocate svn://svn.apama.com/branches/$REALBRANCH http://svn.apama.com/dev/branches/$REALBRANCH
echo "All done and switch to R/W repository"
