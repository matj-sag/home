#!/usr/bin/env bash

set -e

usage() {
	echo "Usage: bisect <working copy> <broken revision> <good revision> <test> [<outcome>] [<test options...>]"
}

if [ -z "$4" ]; then
	usage
	exit 1
fi

WCPATH="$1"
badrev="$2"
goodrev="$3"
TEST="$4"

if [ -z "$5" ]; then
	outcome=PASSED
else
	outcome="$5"
	shift
fi

shift
shift
shift
shift
TESTOPTIONS="$*"

if ! [ -d "$WCPATH" ]; then
	echo "Cannot find working copy $WCPATH"
	usage
	exit 1
fi

cd "$WCPATH"

if ! svn info >/dev/null 2>&1; then
	echo "$WCPATH does not appear to be an svn working copy"
	usage
	exit 1
fi

TESTPATH="`find apama-test -name "$TEST" -and -type d`"

if ! [ -d "$TESTPATH" ]; then
	echo "Can't find test $TEST in working copy"
	usage
	exit 1
fi
TESTPATH="`dirname "$TESTPATH"`"

echo -n "Bisecting $WCPATH over range "

if (( $badrev > $goodrev )); then
	
	regression=true
	top=$badrev
	bottom=$goodrev
	echo -n "$goodrev (good) ... $badrev (bad)"

else

	regression=false
	top=$goodrev
	bottom=$badrev
	echo -n "$badrev (bad) ... $goodrev (good)"
	
fi

echo " using test $TEST as a verifier"

LOGPATH=$WCPATH/bisect
mkdir -p $LOGPATH
echo "Logs will be written to $LOGPATH"

while (( $top > $bottom )); do

	diff=$(( $top - $bottom )) 
	diff=$(( $diff / 2 ))
	if [ "$diff" = "0" ]; then diff=1; fi
	trial=$(( $bottom + $diff ))

	if [ "$trial" = "$bottom" ]; then break; fi
	if [ "$trial" = "$top" ]; then break; fi

	echo "top=$top, bottom=$bottom, trial=$trial"

	echo -n "Trying r$trial ... "

	svn up -r$trial apama-src &> $LOGPATH/$trial-up.log
	gmake -j16 -C apama-src > $LOGPATH/$trial-build.log 2>&1 || (
		gmake -j16 -C apama-src clean &> $LOGPATH/$trial-build.log
		gmake -j16 -C apama-src >> $LOGPATH/$trial-build.log 2>&1
	)
	pushd "$TESTPATH" &>/dev/null
	./runTest.py $TESTOPTIONS $TEST &> $LOGPATH/$trial-run.log
	popd &>/dev/null
	sed -n '/Outcome/s/.*: *//p' $LOGPATH/$trial-run.log
	if grep PASSED $LOGPATH/$trial-run.log &>/dev/null; then
		if [ "$regression" = "true" ]; then
			bottom=$trial
		else
			top=$trial
		fi
	else
		if [ "$regression" = "true" ]; then
			top=$trial
		else
			bottom=$trial
		fi
	fi
done

echo "Bisect finished, regression is between r$bottom and r$top"
